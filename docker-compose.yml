version: '3.9'

services:
  db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: fortaivo
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  server:
    build:
      context: ./server
    depends_on:
      - db
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/fortaivo
      PORT: 8080
      CORS_ORIGIN: http://localhost:5173
      JWT_SECRET: devsecret
      UPLOAD_DIR: /app/uploads
    ports:
      - "8080:8080"
    volumes:
      - uploads_data:/app/uploads
      # Mount source code for hot reload (no rebuild needed)
      - ./server/src:/app/src
      - ./server/prisma:/app/prisma
      - ./server/package.json:/app/package.json
      - ./server/tsconfig.json:/app/tsconfig.json
      # Prevent overwriting node_modules
      - /app/node_modules

  web:
    build:
      context: .
    depends_on:
      - server
      - ollama
    environment:
      VITE_API_URL: http://localhost:8080
      VITE_USE_LOCAL_LLM: "true"
      VITE_OLLAMA_URL: http://localhost:11434
    ports:
      - "5173:5173"
    volumes:
      # Mount source code for hot reload (no rebuild needed)
      - ./src:/app/src
      - ./public:/app/public
      - ./index.html:/app/index.html
      - ./vite.config.ts:/app/vite.config.ts
      - ./tsconfig.json:/app/tsconfig.json
      - ./tsconfig.app.json:/app/tsconfig.app.json
      - ./tsconfig.node.json:/app/tsconfig.node.json
      - ./package.json:/app/package.json
      - ./tailwind.config.js:/app/tailwind.config.js
      - ./postcss.config.js:/app/postcss.config.js
      # Prevent overwriting node_modules
      - /app/node_modules
    command: ["npm", "run", "dev", "--", "--host"]

  # Database admin interface (like Supabase dashboard)
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    depends_on:
      - db
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@fortaivo.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin

  # Local LLM inference service using Ollama
  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_ORIGINS=http://localhost:5173,http://localhost:8080
    # GPU support (uncomment if you have NVIDIA GPU)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

volumes:
  db_data:
  pgadmin_data:
  ollama_data:
  uploads_data:


